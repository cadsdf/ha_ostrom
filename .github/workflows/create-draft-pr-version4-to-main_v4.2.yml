# URL: place this file at .github/workflows/create-draft-pr-version4-to-main_v4.2.yml in your repository
name: Create Draft PR version4 → main_V4.2

on:
  workflow_dispatch:
    inputs:
      head_branch:
        description: 'Branch mit version4 Inhalten (head)'
        required: false
        default: 'version4'
      base_branch:
        description: 'Zielbranch (base) in den gemerged / gesynct werden soll'
        required: false
        default: 'main_V4.2'
      pr_title:
        description: 'Titel des PR'
        required: false
        default: 'Sync version4 implementation: update ostrom api, coordinator, sensors and simulate_error service'
      pr_body:
        description: 'Beschreibung für PR (Markdown erlaubt)'
        required: false
        default: |
          This draft PR was created automatically by a workflow to sync the working version4 implementation into branch **main_V4.2**.
          Commit message: "Sync version4 implementation: update ostrom api, coordinator, sensors and simulate_error service"

permissions:
  contents: write        # erlaubt Branch/PR-Erstellung
  pull-requests: write   # erlaubt PR-Erstellung

jobs:
  create_draft_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create draft pull request from head -> base
        uses: actions/github-script@v6
        with:
          script: |
            // Read inputs from the workflow_dispatch event
            const head = (github.context.payload.inputs && github.context.payload.inputs.head_branch) || 'version4';
            const base = (github.context.payload.inputs && github.context.payload.inputs.base_branch) || 'main_V4.2';
            const title = (github.context.payload.inputs && github.context.payload.inputs.pr_title) || `Sync ${head} into ${base}`;
            const body = (github.context.payload.inputs && github.context.payload.inputs.pr_body) || '';

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            core.info(`Creating draft PR from ${owner}:${head} -> ${base}`);

            // check for existing open PR with same head and base
            const { data: existing } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${head}`,
              base,
              per_page: 100,
            });

            if (existing && existing.length) {
              const pr = existing[0];
              core.info(`An open PR already exists: #${pr.number} ${pr.html_url}`);
              core.setOutput('pr_number', pr.number.toString());
              core.setOutput('pr_url', pr.html_url);
              return;
            }

            // create draft PR
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title,
              head,
              base,
              body,
              draft: true,
            });

            core.info(`Draft PR created: #${pr.number} ${pr.html_url}`);
            core.setOutput('pr_number', pr.number.toString());
            core.setOutput('pr_url', pr.html_url);
